# GMRemake Martingale EA - 邏輯流程圖

## 主執行流程 (Main Execution Flow)

```
┌─────────────────────────────────────────┐
│          EA 初始化                      │
│          (OnInit)                       │
│  • 初始化入場距離陣列                   │
│  • 初始化手數陣列                       │
│  • 列印確認訊息                         │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│          每個 Tick (報價更新)           │
│          (OnTick)                       │
└────────────────┬────────────────────────┘
                 │
                 ▼
        ┌────────────────┐
        │ 檢查點差       │
        │ > 最大點差?    │
        └───┬────────┬───┘
            │ 是     │ 否
            │        │
            ▼        ▼
           返回     繼續
                     │
                     ▼
        ┌─────────────────────┐
        │   計算訂單          │
        │ • 計算買單數量      │
        │ • 計算賣單數量      │
        │ • 追蹤最後價格      │
        └──────────┬──────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │ 管理移動止損         │
        │  • 檢查所有訂單      │
        │  • 更新止損位 (SL)   │
        └──────────┬───────────┘
                   │
           ┌───────┴───────┐
           │               │
           ▼               ▼
    ┌──────────┐    ┌──────────┐
    │檢查買入  │    │檢查賣出  │
    │進場      │    │進場      │
    └──────────┘    └──────────┘
```

## 買入進場邏輯 (Buy Entry Logic Flow)

```
┌──────────────────────────────────────────┐
│        檢查買入進場 (第 N 層)            │
└──────────────────┬───────────────────────┘
                   │
                   ▼
          ┌────────────────┐
          │ 層數 > 最大值? │
          └───┬────────┬───┘
              │ 是     │ 否
              │        │
              ▼        ▼
             返回     繼續
                       │
                       ▼
              ┌────────────────┐
              │  層數 = 1?     │
              └───┬────────┬───┘
                  │ 是     │ 否
                  │        │
                  ▼        ▼
         ┌─────────────┐  ┌──────────────────┐
         │  首單       │  │  馬丁格爾        │
         │  邏輯       │  │  加倉邏輯        │
         │             │  │  (第 2-8 層)     │
         └──────┬──────┘  └────────┬─────────┘
                │                  │
                │                  ▼
                │         ┌────────────────────┐
                │         │ 檢查與上一張       │
                │         │ 買單的虧損距離     │
                │         └────────┬───────────┘
                │                  │
                │                  ▼
                │         ┌────────────────────┐
                │         │ 虧損 >= 入場       │
                │         │ 距離 N?            │
                │         └───┬────────┬───────┘
                │             │ 是     │ 否
                │             │        │
                │             │        ▼
                │             │       返回
                │             │
                │             ▼
                │    ┌─────────────────────┐
                │    │ 啟用趨勢保護?       │
                │    │ (Trend Protection)  │
                │    └───┬────────┬────────┘
                │        │ 是     │ 否
                │        │        │
                │        ▼        │
                │   ┌─────────┐  │
                │   │ 價格高於│  │
                │   │ 前一根? │  │
                │   │ (收陽)  │  │
                │   └─┬───┬───┘  │
                │     │否 │是    │
                │     │   │      │
                │     ▼   └──────┘
                │    返回    │
                │            │
                └────────────┴───────────┐
                                         │
                                         ▼
                              ┌──────────────────┐
                              │ 啟用 MACD 保護?  │
                              │ (MACD Protection)│
                              └───┬──────┬───────┘
                                  │ 是   │ 否
                                  │      │
                                  ▼      │
                           ┌──────────┐ │
                           │ 檢查     │ │
                           │ MACD     │ │
                           │ 趨勢     │ │
                           └─┬───┬────┘ │
                             │OK │失敗  │
                             │   │      │
                             │   ▼      │
                             │  返回    │
                             │          │
                             └──────────┴─────┐
                                              │
                                              ▼
                                   ┌───────────────────┐
                                   │ EMA 過濾器檢查    │
                                   │ • 檢查長週期 EMA  │
                                   │ • 檢查短週期 EMA  │
                                   └──┬────────┬───────┘
                                      │ 通過   │ 失敗
                                      │        │
                                      │        ▼
                                      │       返回
                                      │
                                      ▼
                            ┌──────────────────┐
                            │  開立買單        │
                            │  • 手數 N        │
                            │  • 價格 Ask      │
                            │  • 魔術編號      │
                            └──────────────────┘
```

## 賣出進場邏輯 (Sell Entry Logic Flow)

*賣出邏輯與買入邏輯鏡像對稱，主要差異在於方向判斷。*

1. **首單檢查**：
   - 價格是否低於 `Low[1] - EntryDistance1`。
2. **加倉檢查**：
   - 現價是否高於上一張賣單 `EntryDistanceN` (逆勢加倉)。
3. **趨勢保護**：
   - 若啟用，檢查前一根 K 線是否收陰 (價格低於前一根)。
4. **MACD 保護**：
   - 若啟用，檢查 MACD 是否顯示強烈多頭趨勢 (若是則暫停賣出)。
5. **EMA 過濾**：
   - 若啟用，檢查價格是否符合 EMA 條件 (例如：只在 EMA 之下做空)。

---

## 關鍵函式說明

### `CheckBuyEntry(int level)`
- **功能**：評估是否應該開啟第 `level` 層的買單。
- **輸入**：層數 (1-8)。
- **邏輯**：
  - 驗證層數限制。
  - 計算需要的入場價格。
  - 執行所有過濾器 (趨勢, MACD, EMA)。
  - 若所有條件滿足，呼叫 `OpenBuyOrder`。

### `CheckSellEntry(int level)`
- **功能**：評估是否應該開啟第 `level` 層的賣單。
- **輸入**：層數 (1-8)。
- **邏輯**：與買入邏輯相反。

### `ManageTrailingStop()`
- **功能**：管理所有未平倉訂單的止損位。
- **邏輯**：
  - 遍歷所有訂單。
  - 計算加權平均入場價 (Break Even Price)。
  - 當利潤超過 `TrailingStart` 時，啟動移動止損。
  - 隨著利潤增加，不斷上移止損位，鎖定利潤。

### `CountOrders()`
- **功能**：統計當前市場上的買單和賣單數量，並記錄最後一單的價格。
- **重要性**：這是馬丁格爾策略正確執行層數判斷的基礎。
